import re

configfile: "workflow/config/config.yaml"

DATASETS = config["datasets"]
REFINE_DATASETS = config.get("refine_datasets", DATASETS)

# Metrics configuration (optional)
METRICS_CFG = config.get("metrics", {})

DEFAULT_AV = {"Fundus-AVSeg", "leuven-haifa"}
AV_GT_DATASETS = set(METRICS_CFG.get("av_gt_datasets", [d for d in DEFAULT_AV if d in DATASETS]))
METRICS_DATASETS = METRICS_CFG.get("datasets", sorted(AV_GT_DATASETS))
METRICS_DIR = METRICS_CFG.get("out_dir", "results/metrics")

RESOLUTIONS = [str(r) for r in config.get("resolutions", ["576", "1024"])]
k_start, k_end = config.get("k_range", [3, 9])
k = range(int(k_start), int(k_end))



# ---------------- GT targets (optional) ----------------
from pathlib import Path
from snakemake.io import glob_wildcards

GT_CFG = config.get("ground_truth", {})
GT_ENABLED = bool(GT_CFG.get("enabled", False))

# default to legacy_root if ground_truth.root not provided
GT_ROOT = Path(GT_CFG.get("root", config.get("legacy_root", "."))).resolve()

AV_CFG = ((GT_CFG.get("av_rgb", {}) or {}).get("datasets", {}) or {}) if GT_ENABLED else {}
VES_CFG = ((GT_CFG.get("vessel_gray", {}) or {}).get("datasets", {}) or {}) if GT_ENABLED else {}

# Datasets that have AV GTs and vessel-only GTs (from config)
AV_GT_DATASETS_ALL = sorted(AV_CFG.keys())
VESSEL_GT_DATASETS = sorted(VES_CFG.keys())

# Split AV datasets into those with and without {other_dir}
AV_GT_WITH_OTHERDIR = [
    d for d in AV_GT_DATASETS_ALL if "{other_dir}" in str(AV_CFG[d].get("pattern", ""))
]
AV_GT_SIMPLE = [d for d in AV_GT_DATASETS_ALL if d not in AV_GT_WITH_OTHERDIR]

# Discover other_dir values for datasets that use {other_dir}
AV_OTHERDIRS = {}
for d in AV_GT_WITH_OTHERDIR:
    abs_pat = str(GT_ROOT / AV_CFG[d]["pattern"])
    ods, _samples = glob_wildcards(abs_pat)
    AV_OTHERDIRS[d] = sorted(set(ods))

# Pre-build targets for other_dir datasets (since expand() doesn't do per-dataset lists nicely)
GT_AV_OTHERDIR_TARGETS = [
    f"data/{d}/{od}/downsampled/{res}px/GTs"
    for d in AV_GT_WITH_OTHERDIR
    for od in AV_OTHERDIRS.get(d, [])
    for res in RESOLUTIONS
]

# --- Metrics targets ---
METRICS_AV_WITH_OTHERDIR = [d for d in METRICS_DATASETS if d in AV_GT_WITH_OTHERDIR]
METRICS_AV_SIMPLE = [d for d in METRICS_DATASETS if d not in METRICS_AV_WITH_OTHERDIR]

METRICS_AV_OTHERDIR_TARGETS = [
    f"{METRICS_DIR}/{d}/{od}/metrics_{res}.csv"
    for d in METRICS_AV_WITH_OTHERDIR
    for od in AV_OTHERDIRS.get(d, [])
    for res in ["1024", "576"]
]

# Split vessel-only datasets into those with and without {other_dir}
VES_GT_WITH_OTHERDIR = [
    d for d in VESSEL_GT_DATASETS if "{other_dir}" in str(VES_CFG[d].get("pattern", ""))
]
VES_GT_SIMPLE = [d for d in VESSEL_GT_DATASETS if d not in VES_GT_WITH_OTHERDIR]

# Discover vessel other_dir values
VES_OTHERDIRS = {}
for d in VES_GT_WITH_OTHERDIR:
    abs_pat = str(GT_ROOT / VES_CFG[d]["pattern"])
    ods, _samples = glob_wildcards(abs_pat)
    VES_OTHERDIRS[d] = sorted(set(ods))

VES_GT_OTHERDIR_TARGETS = [
    f"data/{d}/{od}/downsampled/{res}px/GTs_vessel"
    for d in VES_GT_WITH_OTHERDIR
    for od in VES_OTHERDIRS.get(d, [])
    for res in RESOLUTIONS
]



# Prevent dataset wildcards from accidentally matching paths like "refined/Fundus-AVSeg/k3"
# by constraining them to only configured dataset names.
dataset_regex = "(" + "|".join(re.escape(d) for d in DATASETS) + ")"
res_regex = "(" + "|".join(re.escape(str(r)) for r in RESOLUTIONS) + ")"
wildcard_constraints:
    dataset = dataset_regex,
    res = res_regex,
    k = r"\d+",
    kind = r"(segs_converted|roi_masks_binarized)"



# Rules to include
include: "./rules/vascxgray_to_rgb.smk"
include: "./rules/copy_meta.smk"
include: "./rules/create_roi_masks.smk"
include: "./rules/binarize_masks.smk"
include: "./rules/downsample.smk"
include: "./rules/refinement.smk"
include: "./rules/dice.smk"
include: "./rules/gt_conversion.smk"
include: "./rules/refined_rgb_to_labels.smk"
include: "./rules/vascx_dataset_from_refined.smk"
include: "./rules/vascx_features_from_refined.smk"
include: "./rules/filter_meta.smk"
include: "./rules/vascx_features_from_unrefined.smk"


# Rule order
ruleorder: vascx_features_refined_otherdir > vascx_features_refined_simple
ruleorder: make_vascx_view_otherdir > make_vascx_view_simple

VASCX_REFINED = bool(config.get("vascx", {}).get("refined_features_enabled", True))

if VASCX_REFINED:
    VASCX_REFINED_TARGETS = []

    # Simple datasets
    VASCX_REFINED_TARGETS += expand(
        rules.vascx_features_refined_simple.output.features,
        dataset=SIMPLE_DATASETS,
        k=K_VALUES,
        res=RESOLUTIONS,
    )

    # Other-dir datasets (build strings because expand() can't handle per-dataset other_dir lists cleanly)
    VASCX_REFINED_TARGETS += [
        f"{config.get('vascx', {}).get('features_refined_out', 'results/vascx_features_refined')}/{d}/{od}/k{k}/downsampled/{res}px/vascx_features.tsv"
        for d in OTHERDIR_DATASETS
        for od in OTHERDIRS.get(d, [])
        for k in K_VALUES
        for res in RESOLUTIONS
    ]
else:
    VASCX_REFINED_TARGETS = []

rule all:
    input:
        # Ensure meta gets copied for all datasets
        expand("data/{dataset}/meta/meta.csv", dataset=DATASETS),

        # Final refinement outputs
        expand(
            rules.refinement.output.refined,
            dataset=REFINE_DATASETS,
            res=RESOLUTIONS,
            k=k,
        ),
        
        # Ground-truth outputs (optional; enabled via config['ground_truth']['enabled'])
        # A/V GT datasets without other_dir
        expand("data/{dataset}/downsampled/{res}px/GTs", dataset=AV_GT_SIMPLE, res=RESOLUTIONS),
        # A/V GT datasets with other_dir (targets built explicitly)
        GT_AV_OTHERDIR_TARGETS,
        # Vessel-only GT datasets (grayscale)
        # Vessel-only GT datasets without other_dir
        expand("data/{dataset}/downsampled/{res}px/GTs_vessel", dataset=VES_GT_SIMPLE, res=RESOLUTIONS),
        # Vessel-only GT datasets with other_dir
        VES_GT_OTHERDIR_TARGETS,


        expand(f"{METRICS_DIR}" + "/{dataset}/metrics_1024.csv", dataset=METRICS_AV_SIMPLE),
        expand(f"{METRICS_DIR}" + "/{dataset}/metrics_576.csv",  dataset=METRICS_AV_SIMPLE),
        METRICS_AV_OTHERDIR_TARGETS,


        expand(
            rules.refined_rgb_to_labels.output.out_dir,
            dataset=REFINE_DATASETS,
            res=RESOLUTIONS,
            k=k,
        ),

        VASCX_REFINED_TARGETS,

    log:
        errors="logs/all.err",
        output="logs/all.log"
